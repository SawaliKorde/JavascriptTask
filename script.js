let rowToDelete=null;const deleteModal=new bootstrap.Modal(document.getElementById("deleteConfirmModal")),addNewEntryModal=new bootstrap.Modal(document.getElementById("addNewModal"));let lastId=15,currentSortColumn="",currentSortOrder="asc",currentRow=-1;async function populateTable(){try{let e=await fetch("https://sawalikorde.github.io/JavascriptTask/invoices.json"),t=await e.json(),n=document.getElementById("tableBody");t.forEach((e,t)=>{let r=n.insertRow();r.innerHTML=`
    <td>${e.id}</td>
    <td contenteditable="false">${e.chemicalName}</td>
    <td contenteditable="false">${e.vendor}</td>
    <td contenteditable="false">${e.density.toFixed(2)}</td>
    <td contenteditable="false">${e.viscosity.toFixed(2)}</td>
    <td contenteditable="false">${e.packaging}</td>
    <td contenteditable="false">${e.packSize?e.packSize.toFixed(2):"N/A"}</td>
    <td contenteditable="false">${e.unit}</td>
    <td contenteditable="false">${e.quantity.toFixed(2)}</td>
    <td>
        <button class="edit-btn" onclick="editRow(this)" style="background: none; border: none; cursor: pointer;">
            <svg fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"></path>
            </svg>
        </button>
        <button class="save-btn" onclick="saveRow(this, ${t})" style="background: none; border: none; display: none; cursor: pointer;">
            <svg fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
            </svg>
        </button>
        <button class="delete-btn" onclick="deleteRow(this)" style="background: none; border: none; cursor: pointer;">
            <svg fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
            </svg>
        </button>
    </td>
`}),window.invoicesData=t}catch(r){console.error("Error loading the JSON data:",r),document.getElementById("tableBody").innerHTML='<tr><td colspan="9">Error loading data. Please try again later.</td></tr>'}}function editRow(e){let t=e.closest("tr"),n=t.querySelectorAll('td[contenteditable="false"]');t.style.backgroundColor="#e0f7fa",n.forEach(e=>{e.setAttribute("contenteditable","true"),e.style.backgroundColor="#ffe0b2"}),t.querySelector(".save-btn").style.display="inline-block",e.style.display="none";let r=e=>{if("Enter"===e.key){e.preventDefault();let n=t.querySelector(".save-btn");saveRow(n,Array.from(t.parentNode.children).indexOf(t))}};t.addEventListener("keypress",r);let o=e=>{t.contains(e.target)||(cancelEdit(t),document.removeEventListener("click",o))};document.addEventListener("click",o)}function cancelEdit(e){let t=e.querySelectorAll('td[contenteditable="true"]');t.forEach(e=>{e.setAttribute("contenteditable","false"),e.style.backgroundColor=""}),e.style.backgroundColor="",e.querySelector(".edit-btn").style.display="inline-block",e.querySelector(".save-btn").style.display="none",e.removeEventListener("keypress",e.dataset.keyPressHandler),delete e.dataset.keyPressHandler}function saveRow(e,t){let n=e.closest("tr"),r=n.querySelectorAll("td[contenteditable]"),o=/^[a-zA-Z\s]+$/,a=/^[+]?\d*\.?\d+$/,i=[{name:"Chemical Name",pattern:o,required:!0},{name:"Vendor",pattern:o,required:!0},{name:"Density",pattern:a,required:!0},{name:"Viscosity",pattern:a,required:!0},{name:"Packaging",pattern:o,required:!0},{name:"Pack Size",pattern:a,required:!0},{name:"Unit",pattern:/^(kg|L)$/,required:!0},{name:"Quantity",pattern:a,required:!0}],l={};for(let d=0;d<r.length;d++){let s=r[d].innerText.trim(),c=i[d];if(c.required&&!s){showToast(`${c.name} cannot be empty.`,"blue");return}if(!c.pattern.test(s)){showToast(`${c.name} has an invalid format.`,"blue");return}l[c.name]=c.pattern===a?parseFloat(s):s}Object.assign(window.invoicesData[t],l),r.forEach(e=>{e.setAttribute("contenteditable","false"),e.style.backgroundColor=""}),n.style.backgroundColor="",n.querySelector(".edit-btn").style.display="inline-block",e.style.display="none",showToast("Data saved successfully!","green"),console.log("Updated data:",window.invoicesData)}function deleteRow(e){rowToDelete=e.closest("tr"),deleteModal.show()}function showToast(e,t){let n=document.getElementById("liveToast"),r=n.querySelector(".toast-body");r.textContent=e,"green"===t?(n.classList.add("bg-success","text-white"),n.classList.remove("bg-primary")):"blue"===t&&(n.classList.add("bg-primary","text-white"),n.classList.remove("bg-success"));let o=new bootstrap.Toast(n,{delay:3e3,autohide:!0});o.show()}function addNewEntry(){let e=document.getElementById("saveNewEntry"),t=document.getElementById("addNewForm");addNewEntryModal.show(),e.replaceWith(e.cloneNode(!0));let n=document.getElementById("saveNewEntry");document.getElementById("chemicalName").addEventListener("input",()=>{document.getElementById("chemicalNameError").innerText=""}),document.getElementById("vendor").addEventListener("input",()=>{document.getElementById("vendorError").innerText=""}),document.getElementById("density").addEventListener("input",()=>{document.getElementById("densityError").innerText=""}),document.getElementById("viscosity").addEventListener("input",()=>{document.getElementById("viscosityError").innerText=""}),document.getElementById("packaging").addEventListener("input",()=>{document.getElementById("packagingError").innerText=""}),document.getElementById("packSize").addEventListener("input",()=>{document.getElementById("packSizeError").innerText=""}),document.getElementById("unit").addEventListener("change",()=>{document.getElementById("unitError").innerText=""}),document.getElementById("quantity").addEventListener("input",()=>{document.getElementById("quantityError").innerText=""}),n.addEventListener("click",()=>{let e=document.getElementById("chemicalName").value.trim(),n=document.getElementById("vendor").value.trim(),r=parseFloat(document.getElementById("density").value.trim()),o=parseFloat(document.getElementById("viscosity").value.trim()),a=document.getElementById("packaging").value.trim(),i=parseFloat(document.getElementById("packSize").value.trim()),l=document.getElementById("unit").value,d=parseFloat(document.getElementById("quantity").value.trim()),s=/^[a-zA-Z\s]+$/,c=/^[+]?\d*\.?\d+$/;if(!s.test(e)){document.getElementById("chemicalNameError").innerText="Please use alphabets only (exp: a,b,c)";return}if(!s.test(n)){document.getElementById("vendorError").innerText="Please use alphabets only (exp: a,b,c)";return}if(!c.test(r.toString())||r<=0){document.getElementById("densityError").innerText="Density must be positive number";return}if(!c.test(o.toString())||o<=0){document.getElementById("viscosityError").innerText="Viscosity must be positive number";return}if(!s.test(a)){document.getElementById("packagingError").innerText="Packaging is invalid";return}if(!c.test(i.toString())||i<=0){document.getElementById("packSizeError").innerText="Packsize must be a positive number";return}if(!/^(kg|L)$/.test(l)){document.getElementById("chemicalNameError").innerText='Unit must be either "kg" or "L"';return}if(!c.test(d.toString())||d<=0){document.getElementById("quantityError").innerText="Quantity must be positive number";return}let u={id:++lastId,chemicalName:e,vendor:n,density:r,viscosity:o,packaging:a,packSize:i,unit:l,quantity:d};window.invoicesData.push(u);let $=document.getElementById("tableBody"),_=`
<tr>
    <td>${u.id}</td>
    <td contenteditable="false">${u.chemicalName}</td>
    <td contenteditable="false">${u.vendor}</td>
    <td contenteditable="false">${u.density.toFixed(2)}</td>
    <td contenteditable="false">${u.viscosity.toFixed(2)}</td>
    <td contenteditable="false">${u.packaging}</td>
    <td contenteditable="false">${u.packSize.toFixed(2)}</td>
    <td contenteditable="false">${u.unit}</td>
    <td contenteditable="false">${u.quantity.toFixed(2)}</td>
    <td>
        <button class="edit-btn" onclick="editRow(this)" style="background: none; border: none; cursor: pointer;">
            <svg fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"></path>
            </svg>
        </button>
        <button class="save-btn" onclick="saveRow(this, ${window.invoicesData.length-1})" style="background: none; border: none; display: none; cursor: pointer;">
            <svg fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
            </svg>
        </button>
        <button class="delete-btn" onclick="deleteRow(this)" style="background: none; border: none; cursor: pointer;">
            <svg fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
            </svg>
        </button>
    </td>
`;$.insertAdjacentHTML("beforeend",_),addNewEntryModal.hide(),t.reset(),showToast("New chemical entry added successfully!","green")})}function sortTable(e){let t=document.getElementById("tableBody"),n=Array.from(t.rows),r="asc";currentSortColumn===e&&"asc"===currentSortOrder&&(r="desc"),n.sort((t,n)=>{let o=t.cells[getColumnIndex(e)].innerText,a=n.cells[getColumnIndex(e)].innerText;return"density"===e||"viscosity"===e||"packSize"===e||"quantity"===e?"asc"===r?parseFloat(o)-parseFloat(a):parseFloat(a)-parseFloat(o):"unit"===e?"asc"===r?"kg"===o?-1:1:"kg"===o?1:-1:"asc"===r?o.localeCompare(a):a.localeCompare(o)}),n.forEach(e=>t.appendChild(e)),currentSortColumn=e,currentSortOrder=r,updateSortArrows()}function getColumnIndex(e){switch(e){case"chemicalName":return 1;case"vendor":return 2;case"density":return 3;case"viscosity":return 4;case"packaging":return 5;case"packSize":return 6;case"unit":return 7;case"quantity":return 8;default:return -1}}function updateSortArrows(){let e=document.querySelectorAll(".sort-arrow");e.forEach(e=>{e.innerText=""});let t=document.getElementById(`arrow-${currentSortColumn}`);t.innerText="asc"===currentSortOrder?" ↑":" ↓"}function highlightRow(e){let t=document.querySelectorAll("#tableBody tr");t.forEach(e=>e.classList.remove("highlight")),e>=0&&e<t.length&&(t[e].classList.add("highlight"),t[e].scrollIntoView({behavior:"smooth",block:"center"}))}function navigateTable(e){let t=document.querySelectorAll("#tableBody tr");"down"===e?currentRow=Math.min(currentRow+1,t.length-1):"up"===e&&(currentRow=Math.max(currentRow-1,0)),highlightRow(currentRow)}function refreshTable(){location.reload()}document.getElementById("confirmDelete").addEventListener("click",function(){rowToDelete&&(rowToDelete.remove(),showToast("Row deleted successfully","green"),deleteModal.hide())}),document.getElementById("deleteConfirmModal").addEventListener("hidden.bs.modal",function(){rowToDelete=null}),document.addEventListener("keydown",e=>{"ArrowDown"===e.key?(e.preventDefault(),navigateTable("down")):"ArrowUp"===e.key&&(e.preventDefault(),navigateTable("up"))}),window.onload=populateTable;